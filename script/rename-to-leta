#!/usr/bin/env python3
"""
Rename lspcmd to leta throughout the codebase.

This script:
1. Renames directories (lspcmd/ -> leta/, skills/lspcmd/ -> skills/leta/)
2. Renames files with lspcmd in the name
3. Updates all file contents to replace lspcmd -> leta
4. Handles case variations (LSPCMD -> LETA, Lspcmd -> Leta)
"""

import os
import re
import shutil
import subprocess
from pathlib import Path

PROJECT_ROOT = Path(__file__).parent.parent


def git(*args: str) -> None:
    """Run a git command."""
    subprocess.run(["git", *args], cwd=PROJECT_ROOT, check=True)


def find_files_with_content(pattern: str) -> list[Path]:
    """Find all files containing the pattern."""
    result = subprocess.run(
        ["grep", "-rl", pattern, "."],
        cwd=PROJECT_ROOT,
        capture_output=True,
        text=True,
    )
    if result.returncode == 0:
        return [Path(p) for p in result.stdout.strip().split("\n") if p]
    return []


def should_process_file(path: Path) -> bool:
    """Check if we should process this file."""
    path_str = str(path)
    
    # Skip directories
    if path.is_dir():
        return False
    
    # Skip git directory
    if ".git/" in path_str or path_str == ".git":
        return False
    
    # Skip virtual environments
    if ".venv/" in path_str:
        return False
    
    # Skip pycache
    if "__pycache__" in path_str:
        return False
    
    # Skip egg-info (will be regenerated)
    if ".egg-info" in path_str:
        return False
    
    # Skip binary files
    if path.suffix in {".pyc", ".pyo", ".so", ".dylib", ".class", ".lock"}:
        return False
    
    # Skip test fixtures (except config files)
    if "test/fixtures/" in path_str:
        return False
    
    # Skip this script itself
    if path.name == "rename-to-leta":
        return False
    
    return True


def replace_in_file(path: Path) -> bool:
    """Replace lspcmd with leta in file contents. Returns True if changed."""
    try:
        content = path.read_text()
    except UnicodeDecodeError:
        return False
    
    original = content
    
    # Replace variations (order matters - do specific ones first)
    # LSPCMD -> LETA
    content = content.replace("LSPCMD", "LETA")
    # lspcmd -> leta (most common)
    content = content.replace("lspcmd", "leta")
    # Lspcmd -> Leta (rarely used but just in case)
    content = content.replace("Lspcmd", "Leta")
    
    if content != original:
        path.write_text(content)
        return True
    return False


def main():
    os.chdir(PROJECT_ROOT)
    
    print("=== Renaming lspcmd to leta ===\n")
    
    # Step 1: Find all files that need content replacement
    print("Step 1: Finding files with 'lspcmd' in content...")
    files_to_update: set[Path] = set()
    
    for pattern in ["lspcmd", "LSPCMD", "Lspcmd"]:
        result = subprocess.run(
            ["grep", "-rl", pattern, "."],
            cwd=PROJECT_ROOT,
            capture_output=True,
            text=True,
        )
        if result.returncode == 0:
            for p in result.stdout.strip().split("\n"):
                if p:
                    files_to_update.add(Path(p))
    
    files_to_update = {f for f in files_to_update if should_process_file(f)}
    print(f"  Found {len(files_to_update)} files to update\n")
    
    # Step 2: Update file contents (before renaming directories)
    print("Step 2: Updating file contents...")
    updated_count = 0
    for path in sorted(files_to_update):
        if replace_in_file(path):
            print(f"  Updated: {path}")
            updated_count += 1
    print(f"  Updated {updated_count} files\n")
    
    # Step 3: Rename skill directory
    print("Step 3: Renaming skills/lspcmd -> skills/leta...")
    skill_old = PROJECT_ROOT / "skills" / "lspcmd"
    skill_new = PROJECT_ROOT / "skills" / "leta"
    if skill_old.exists():
        git("mv", "skills/lspcmd", "skills/leta")
        print("  Done\n")
    else:
        print("  Already renamed or doesn't exist\n")
    
    # Step 4: Rename main package directory
    print("Step 4: Renaming lspcmd/ -> leta/...")
    pkg_old = PROJECT_ROOT / "lspcmd"
    pkg_new = PROJECT_ROOT / "leta"
    if pkg_old.exists():
        git("mv", "lspcmd", "leta")
        print("  Done\n")
    else:
        print("  Already renamed or doesn't exist\n")
    
    # Step 5: Rename files with lspcmd in the name
    print("Step 5: Renaming files with 'lspcmd' in name...")
    
    # Find files with lspcmd in name
    result = subprocess.run(
        ["find", ".", "-name", "*lspcmd*", "-type", "f"],
        cwd=PROJECT_ROOT,
        capture_output=True,
        text=True,
    )
    
    files_to_rename = []
    if result.returncode == 0:
        for p in result.stdout.strip().split("\n"):
            if p and should_process_file(Path(p)):
                files_to_rename.append(p)
    
    for old_path in files_to_rename:
        new_path = old_path.replace("lspcmd", "leta")
        if old_path != new_path:
            print(f"  {old_path} -> {new_path}")
            try:
                git("mv", old_path, new_path)
            except subprocess.CalledProcessError:
                # File might not be tracked, use regular mv
                shutil.move(PROJECT_ROOT / old_path, PROJECT_ROOT / new_path)
    
    print("  Done\n")
    
    # Step 6: Delete old egg-info
    print("Step 6: Cleaning up old build artifacts...")
    egg_info = PROJECT_ROOT / "lspcmd.egg-info"
    if egg_info.exists():
        shutil.rmtree(egg_info)
        print("  Removed lspcmd.egg-info/")
    
    # Also check for leta.egg-info in case we need to clean up
    leta_egg = PROJECT_ROOT / "leta.egg-info"
    if leta_egg.exists():
        shutil.rmtree(leta_egg)
        print("  Removed leta.egg-info/")
    
    print("  Done\n")
    
    # Step 7: Update pyrightconfig.json (it references lspcmd)
    print("Step 7: Verifying pyrightconfig.json...")
    pyright_config = PROJECT_ROOT / "pyrightconfig.json"
    if pyright_config.exists():
        content = pyright_config.read_text()
        if "leta" in content:
            print("  Already updated")
        elif "lspcmd" in content:
            content = content.replace("lspcmd", "leta")
            pyright_config.write_text(content)
            print("  Updated")
    print()
    
    # Step 8: Stage all changes
    print("Step 8: Staging all changes...")
    git("add", "-A")
    print("  Done\n")
    
    print("=== Rename complete! ===")
    print("\nNext steps:")
    print("1. Review changes with: git diff --cached")
    print("2. Reinstall package: uv tool install -e . --python 3.13 --reinstall")
    print("3. Restart the daemon: leta daemon restart")
    print("4. Run tests to verify: ./script/integration-test")
    print("5. Commit: git commit -m 'Rename lspcmd to leta'")


if __name__ == "__main__":
    main()
